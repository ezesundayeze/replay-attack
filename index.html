<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Replay Attack Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        padding: 10px;
        margin: 5px;
        cursor: pointer;
        background: #4caf50;
        color: white;
        border: none;
      }
      button#replay-btn {
        background: #f44336;
      }
      #output {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        margin-top: 20px;
      }
      .contract-info {
        margin: 20px 0;
        padding: 10px;
        background: #e9e9e9;
      }
    </style>
  </head>
  <body>
    <h1>Ethereum Replay Attack Demo</h1>

    <h2>1. Deploy Contracts</h2>
    <button id="deploy-vulnerable">Deploy Vulnerable Contract</button>
    <button id="deploy-fixed">Deploy Fixed Contract</button>

    <h2>2. Sign & Claim</h2>
    <button id="sign-claim-vulnerable">Sign & Claim (Vulnerable)</button>
    <button id="sign-claim-fixed">Sign & Claim (Fixed)</button>

    <h2>3. Attack</h2>
    <button id="replay-btn">Replay Attack (New Instance)</button>

    <div class="contract-info">
      <h3>Deployed Contracts</h3>
      <p>
        <strong>Vulnerable:</strong> <span id="vulnerable-address">None</span>
      </p>
      <p>
        <strong>Replay Instance:</strong> <span id="replay-address">None</span>
      </p>
      <p><strong>Fixed:</strong> <span id="fixed-address">None</span></p>
    </div>

    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
    <script>
      // Global variables
      let web3;
      let contracts = {
        vulnerable: null,
        fixed: null,
        replayInstance: null,
      };
      let lastSignature = null;

      // Initialize Web3 when page loads
      window.onload = async function () {
        if (window.ethereum) {
          web3 = new Web3(window.ethereum);
          try {
            await window.ethereum.request({ method: "eth_requestAccounts" });
            setupEventListeners();
            logOutput("Connected to MetaMask!");
          } catch (error) {
            logOutput("User denied account access");
          }
        } else {
          alert("Please install MetaMask!");
        }
      };

      // Set up all button click handlers
      function setupEventListeners() {
        document
          .getElementById("deploy-vulnerable")
          .addEventListener("click", deployVulnerableContract);
        document
          .getElementById("deploy-fixed")
          .addEventListener("click", deployFixedContract);
        document
          .getElementById("sign-claim-vulnerable")
          .addEventListener("click", signAndClaimVulnerable);
        document
          .getElementById("sign-claim-fixed")
          .addEventListener("click", signAndClaimFixed);
        document
          .getElementById("replay-btn")
          .addEventListener("click", replayAttack);
      }

      // Contract ABIs (bytecode removed for brevity)
      function getVulnerableContract() {
        return {
          abi: [
            {
              inputs: [
                { name: "message", type: "bytes32" },
                { name: "v", type: "uint8" },
                { name: "r", type: "bytes32" },
                { name: "s", type: "bytes32" },
              ],
              name: "claim",
              outputs: [],
              stateMutability: "nonpayable",
              type: "function",
            },
            {
              inputs: [{ name: "", type: "address" }],
              name: "hasClaimed",
              outputs: [{ name: "", type: "bool" }],
              stateMutability: "view",
              type: "function",
            },
          ],
          bytecode:
            "6080604052348015600e575f80fd5b506105418061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c806309c8d1731461003857806373b2e80e14610054575b5f80fd5b610052600480360381019061004d91906102ae565b610084565b005b61006e6004803603810190610069919061036c565b610225565b60405161007b91906103b1565b60405180910390f35b5f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff161561010d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161010490610424565b60405180910390fd5b5f6001858585856040515f81526020016040526040516101309493929190610460565b6020604051602081039080840390855afa158015610150573d5f803e3d5ffd5b5050506020604051035190503373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16146101ca576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101c1906104ed565b60405180910390fd5b60015f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff0219169083151502179055505050505050565b5f602052805f5260405f205f915054906101000a900460ff1681565b5f80fd5b5f819050919050565b61025781610245565b8114610261575f80fd5b50565b5f813590506102728161024e565b92915050565b5f60ff82169050919050565b61028d81610278565b8114610297575f80fd5b50565b5f813590506102a881610284565b92915050565b5f805f80608085870312156102c6576102c5610241565b5b5f6102d387828801610264565b94505060206102e48782880161029a565b93505060406102f587828801610264565b925050606061030687828801610264565b91505092959194509250565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61033b82610312565b9050919050565b61034b81610331565b8114610355575f80fd5b50565b5f8135905061036681610342565b92915050565b5f6020828403121561038157610380610241565b5b5f61038e84828501610358565b91505092915050565b5f8115159050919050565b6103ab81610397565b82525050565b5f6020820190506103c45f8301846103a2565b92915050565b5f82825260208201905092915050565b7f416c726561647920636c61696d656400000000000000000000000000000000005f82015250565b5f61040e600f836103ca565b9150610419826103da565b602082019050919050565b5f6020820190508181035f83015261043b81610402565b9050919050565b61044b81610245565b82525050565b61045a81610278565b82525050565b5f6080820190506104735f830187610442565b6104806020830186610451565b61048d6040830185610442565b61049a6060830184610442565b95945050505050565b7f496e76616c6964207369676e61747572650000000000000000000000000000005f82015250565b5f6104d76011836103ca565b91506104e2826104a3565b602082019050919050565b5f6020820190508181035f830152610504816104cb565b905091905056fea26469706673582212208e656d227e2843cf369e3e48464ce6b076cc84807c32ae4fc79a801f68379d9c64736f6c634300081a0033",
        };
      }

      function getFixedContract() {
        return {
          abi: [
            {
              inputs: [
                { name: "message", type: "bytes32" },
                { name: "v", type: "uint8" },
                { name: "r", type: "bytes32" },
                { name: "s", type: "bytes32" },
              ],
              name: "claim",
              outputs: [],
              stateMutability: "nonpayable",
              type: "function",
            },
            {
              inputs: [{ name: "", type: "address" }],
              name: "hasClaimed",
              outputs: [{ name: "", type: "bool" }],
              stateMutability: "view",
              type: "function",
            },
          ],
          bytecode:
            "6080604052348015600e575f80fd5b506106058061001c5f395ff3fe608060405234801561000f575f80fd5b5060043610610034575f3560e01c806309c8d1731461003857806373b2e80e14610054575b5f80fd5b610052600480360381019061004d91906102d9565b610084565b005b61006e60048036038101906100699190610397565b610250565b60405161007b91906103dc565b60405180910390f35b5f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff161561010d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101049061044f565b60405180910390fd5b5f8460405160200161011f91906104e1565b6040516020818303038152906040528051906020012090505f6001828686866040515f815260200160405260405161015a9493929190610524565b6020604051602081039080840390855afa15801561017a573d5f803e3d5ffd5b5050506020604051035190503373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16146101f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101eb906105b1565b60405180910390fd5b60015f803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff021916908315150217905550505050505050565b5f602052805f5260405f205f915054906101000a900460ff1681565b5f80fd5b5f819050919050565b61028281610270565b811461028c575f80fd5b50565b5f8135905061029d81610279565b92915050565b5f60ff82169050919050565b6102b8816102a3565b81146102c2575f80fd5b50565b5f813590506102d3816102af565b92915050565b5f805f80608085870312156102f1576102f061026c565b5b5f6102fe8782880161028f565b945050602061030f878288016102c5565b93505060406103208782880161028f565b92505060606103318782880161028f565b91505092959194509250565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6103668261033d565b9050919050565b6103768161035c565b8114610380575f80fd5b50565b5f813590506103918161036d565b92915050565b5f602082840312156103ac576103ab61026c565b5b5f6103b984828501610383565b91505092915050565b5f8115159050919050565b6103d6816103c2565b82525050565b5f6020820190506103ef5f8301846103cd565b92915050565b5f82825260208201905092915050565b7f416c726561647920636c61696d656400000000000000000000000000000000005f82015250565b5f610439600f836103f5565b915061044482610405565b602082019050919050565b5f6020820190508181035f8301526104668161042d565b9050919050565b5f81905092915050565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000005f82015250565b5f6104ab601c8361046d565b91506104b682610477565b601c82019050919050565b5f819050919050565b6104db6104d682610270565b6104c1565b82525050565b5f6104eb8261049f565b91506104f782846104ca565b60208201915081905092915050565b61050f81610270565b82525050565b61051e816102a3565b82525050565b5f6080820190506105375f830187610506565b6105446020830186610515565b6105516040830185610506565b61055e6060830184610506565b95945050505050565b7f496e76616c6964207369676e61747572650000000000000000000000000000005f82015250565b5f61059b6011836103f5565b91506105a682610567565b602082019050919050565b5f6020820190508181035f8301526105c88161058f565b905091905056fea2646970667358221220723526c491a5944caa001f830b85db08c3ceafe6266545492f16a8cc56fbd6d564736f6c634300081a0033",
        };
      }

      // Helper: Split signature into v, r, s
      function splitSig(signature) {
        const r = signature.slice(0, 66);
        const s = "0x" + signature.slice(66, 130);
        const v = parseInt(signature.slice(130, 132), 16);
        return { v, r, s };
      }

      // Deploy Vulnerable Contract
      async function deployVulnerableContract() {
        try {
          const { abi, bytecode } = getVulnerableContract();
          const contract = new web3.eth.Contract(abi);

          contracts.vulnerable = await contract
            .deploy({ data: bytecode })
            .send({ from: ethereum.selectedAddress });

          // await contract.deploy({ data: bytecode })
          //   .send({ from: ethereum.selectedAddress, gas: 3000000 });

          document.getElementById("vulnerable-address").textContent =
            contracts.vulnerable.options.address;
          logOutput(
            `Vulnerable contract deployed at: ${contracts.vulnerable.options.address}`
          );
        } catch (error) {
          logOutput("Deployment failed: " + error.message);
        }
      }

      // Deploy Fixed Contract
      async function deployFixedContract() {
        try {
          const { abi, bytecode } = getFixedContract();
          const contract = new web3.eth.Contract(abi);

          contracts.fixed = await contract
            .deploy({ data: bytecode })
            .send({ from: ethereum.selectedAddress });

          // await contract.deploy({ data: bytecode })
          //   .send({ from: ethereum.selectedAddress, gas: 3000000 });

          document.getElementById("fixed-address").textContent =
            contracts.fixed.options.address;
          logOutput(
            `Fixed contract deployed at: ${contracts.fixed.options.address}`
          );
        } catch (error) {
          logOutput("Deployment failed: " + error.message);
        }
      }

      async function signAndClaimVulnerable() {
        if (!contracts.vulnerable) {
          logOutput("Deploy vulnerable contract first!");
          return;
        }

        try {
          const account = ethereum.selectedAddress;

          // 1. Create the message hash (matches contract expectation)
          const messageHash = web3.utils.soliditySha3(account);

          // 2. Convert hash to Ethereum signed message format
          const ethMessage = web3.utils.sha3(
            "\x19Ethereum Signed Message:\n32" + messageHash.slice(2)
          );

          // 3. Sign the raw hash (not UTF-8)
          const signature = await ethereum.request({
            method: "personal_sign",
            params: [messageHash, account], // Pass raw hash directly
          });

          // 4. Split signature correctly
          const { v, r, s } = splitSig(signature);

          // 5. Call contract
          await contracts.vulnerable.methods
            .claim(messageHash, v, r, s)
            .send({ from: account });

          logOutput("✅ Claim successful!");
        } catch (error) {
          logOutput(`❌ Claim failed: ${error.message}`);
        }
      }

      // Replay Attack
      async function replayAttack() {
        if (!contracts.vulnerable || !lastSignature) {
          logOutput("Deploy vulnerable contract and sign first!");
          return;
        }

        try {
          // Deploy new instance
          const { abi, bytecode } = getVulnerableContract();
          const contract = new web3.eth.Contract(abi);

          contracts.replayInstance = await contract
            .deploy({ data: bytecode })
            .send({ from: ethereum.selectedAddress });

          // await contract.deploy({ data: bytecode })
          //   .send({ from: ethereum.selectedAddress, gas: 3000000 });

          document.getElementById("replay-address").textContent =
            contracts.replayInstance.options.address;
          logOutput(
            `New vulnerable instance deployed at: ${contracts.replayInstance.options.address}`
          );

          // Reuse signature
          const account = ethereum.selectedAddress;
          const message = web3.utils.soliditySha3(account);
          const { v, r, s } = splitSig(lastSignature);

          await contracts.replayInstance.methods
            .claim(message, v, r, s)
            .send({ from: account });
          logOutput("🚨 Replay Attack SUCCESS! Same signature worked again.");
        } catch (error) {
          logOutput("Replay failed: " + error.message);
        }
      }

      // Helper: Log to output div
      function logOutput(text) {
        const output = document.getElementById("output");
        output.innerHTML += `<p>${text}</p>`;
        output.scrollTop = output.scrollHeight;
      }
    </script>
  </body>
</html>
